{"title":"GIF to MP4 conversion for web using NodeJS","description":"GIF to MP4 conversion for performance is all the rage nowadays. But doing so in practice is really difficult, especially for cross-browser compatibility. Learn how to do it right","date":"Sep 25, 2020 1:09 AM","cover_image":"../media/blog-social-intro.png","body":"<p><img src=\"\" alt=\"\" class=\"feature-image\" style=\"display: none;\"></p><div class=\"picture-container\">\n  <div class=\"gif-vid-container\">\n    <video autoplay=\"\" loop=\"\" muted=\"\" playsinline=\"\">\n      <source src=\"../media/harry-firebolt-eats-cupcake/vidgif.mp4\" type=\"video/mp4\">\n      Your browser doesn't support HTML5 video playback. <a href=\"../media/harry-firebolt-eats-cupcake.gif\" target=\"_blank\" rel=\"noopener\">See the gif here</a>\n    </video>\n  </div>\n  </div><p></p>\n<p>Who doesn't love these awesome GIFs? These are used heavily on social media, and many among us(*cough* Myself *cough*) couldn't live without these (Prove me wrong <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜Ž\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f60e.svg\">)</p>\n<p>However, these GIFs are costly. They eat up loads of CPU and GPU power, are huge in file size. This GIF above <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘†\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f446.svg\"> is <mark>890kb</mark> when downloaded. This number may not seem huge, but it's MP4 version is only <mark>132kb</mark>.</p>\n<blockquote>\n<p>It's <strong>85%</strong> smaller <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜®\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f62e.svg\"></p>\n</blockquote>\n<p>And it barely eats any CPU. Even the oldest of devices will play it easily</p>\n<h1 id=\"How-to-convert\"><a class=\"heading-link\" href=\"/blog/gif-to-mp4-ffmpeg-fluent-web#How-to-convert\">#</a>How to convert</h1>\n<p>You can convert a GIF to MP4 by running this command</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #ABB2BF\">ffmpeg </span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">i harry</span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">eats</span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">cupcake.gif </span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">pix_fmt yuv420p </span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">c:v libx264 </span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">movflags </span><span style=\"color: #56B6C2\">+</span><span style=\"color: #ABB2BF\">faststart </span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">filter:v crop</span><span style=\"color: #56B6C2\">=</span><span style=\"color: #98C379\">'floor(in_w/2)*2:floor(in_h/2)*2'</span><span style=\"color: #ABB2BF\"> output.mp4</span></span>\n<span class=\"line\"></span></code></pre>\n<p>What are those weird options? I'll explain later.</p>\n<p>However, you'll have to manually run this on every single GIF.</p>\n<p>But we, the developers don't like to do that<img class=\"emoji\" draggable=\"false\" alt=\"ðŸ™„\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f644.svg\">. So let's automate the process.</p>\n<p><img src=\"\" alt=\"\" class=\"feature-image\" style=\"display: none;\"></p><div class=\"picture-container\">\n  <figure style=\"width: 100%;--padding-top: 75.08333333333333%;\">\n    <picture>\n      <source type=\"image/jpg\" media=\"(min-width: 501px)\" data-srcset=\"../media/dev-automation-10-min/large.jpg\">\n      <source type=\"image/jpg\" media=\"(max-width: 500px)\" data-srcset=\"../media/dev-automation-10-min/small.jpg\">\n      <img alt=\"Placeholder\" data-src=\"../media/dev-automation-10-min/large.jpg\" class=\"lazyload blog-img\">\n    </picture>\n  </figure>\n  </div><p></p>\n<h1 id=\"Install-dependencies\"><a class=\"heading-link\" href=\"/blog/gif-to-mp4-ffmpeg-fluent-web#Install-dependencies\">#</a>Install dependencies</h1>\n<p>We'll require a binary of <code>ffmpeg</code> and will have to figure how to use it. And we'll need to download the <strong>right</strong> binary. What I mean by this is that in a real world application, you'll be deploying the code on cloud/servers, and you'd need FFMPEG there too.</p>\n<p>If it's your own server, you can upload it there manually and it'll work. But you can't directly upload the binary to Cloud environments like Google Cloud Functions/AWS lambda without a lot of preprocessing and testing on your end. You'd have to keep a Ubuntu compatible FFMPEG binary alongside your own OS based binary, and still it won't work properly.</p>\n<p>But thank the NPM Gods, we have the package <a href=\"https://www.npmjs.com/package/@ffmpeg-installer/ffmpeg\" target=\"_blank\" rel=\"noopener\">@ffmpeg-installer/ffmpeg</a> that installs the <strong>right</strong> binary based on the operating system. If you are running Windows, it'll download the <code>ffmpeg.exe</code> file. If the OS is linux based, it'll download specific binary for that.</p>\n<p>And there's also an amazing package called <a href=\"https://www.npmjs.com/package/fluent-ffmpeg\" target=\"_blank\" rel=\"noopener\">fluent-ffmpeg</a> which provides a very declarative, callback-based API to interact with FFMPEG.</p>\n<p>So let's download these. Make sure you have npm setup.</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #ABB2BF\">npm i </span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">D </span><span style=\"color: #E06C75\">@ffmpeg</span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">installer</span><span style=\"color: #56B6C2\">/</span><span style=\"color: #ABB2BF\">ffmpeg fluent</span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">ffmpeg </span><span style=\"color: #E06C75\">@ffprobe</span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">installer</span><span style=\"color: #56B6C2\">/</span><span style=\"color: #ABB2BF\">ffprobe</span></span>\n<span class=\"line\"></span></code></pre>\n<p>The <code>@ffprobe-installer/ffprobe</code> package is also required by FFMPEG.</p>\n<h1 id=\"Code\"><a class=\"heading-link\" href=\"/blog/gif-to-mp4-ffmpeg-fluent-web#Code\">#</a>Code</h1>\n<p>First, let's set up FFMPEG paths in our <code>index.js</code> file:</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">ffmpegInstaller</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"@ffmpeg-installer/ffmpeg\"</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">ffprobe</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"@ffprobe-installer/ffprobe\"</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">ffmpeg</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"fluent-ffmpeg\"</span><span style=\"color: #ABB2BF\">)()</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">setFfprobePath</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E5C07B\">ffprobe</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">path</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">setFfmpegPath</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E5C07B\">ffmpegInstaller</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">path</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span></code></pre>\n<blockquote>\n<p>The code snippet above <img class=\"emoji\" draggable=\"false\" alt=\"â˜\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/261d.svg\"> is not optional. Not having this config will break your program</p>\n</blockquote>\n<p>Now, the code to convert GIF to MP4</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #E06C75\">ffmpeg</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">input</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">gifPath</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">noAudio</span><span style=\"color: #ABB2BF\">()</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">output</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">`vidgif.mp4`</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">on</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"end\"</span><span style=\"color: #ABB2BF\">, () </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"Finished\"</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  })</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">on</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"error\"</span><span style=\"color: #ABB2BF\">, (</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">))</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">run</span><span style=\"color: #ABB2BF\">();</span></span>\n<span class=\"line\"></span></code></pre>\n<ul>\n<li>\n<p><code>.input(gifPath)</code> is inputting the GIF file by its path. Relative paths will work here like <code>../../harry-eats-cupcake.gif</code>.</p>\n</li>\n<li>\n<p><code>.noAudio()</code> will remove all the audio from the file. Makes sense. GIFs don't speak <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜‰\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f609.svg\">.</p>\n</li>\n<li>\n<p><code>.output('vidgif.mp4')</code> is the path where the output file has to be written. FFMPEG will look at the output file's format(<code>.mp4</code> here) and automatically choose the currect library for encoding, <code>libx264</code> for mp4 files.</p>\n</li>\n</ul>\n<blockquote>\n<p><code>libx264</code> is a video encoding library that encodes the video file into H.264 encoding, the most widely supported video codec. <a href=\"https://caniuse.com/mpeg4\" target=\"_blank\" rel=\"noopener\">See here: Caniuse H.264</a></p>\n</blockquote>\n<ul>\n<li>\n<p><code>.on(\"end\")</code> and <code>.on(\"error\")</code> are events that fire when the process finishes or throws an error and shuts down respectively.</p>\n</li>\n<li>\n<p><code>.run()</code> is the most important line here. Without it, the process will not start and you'll staring at your blank terminal waiting for anything to happen, which it won't <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f60f.svg\">.</p>\n</li>\n</ul>\n<p>When this process finishes, you'll have a <code>vidgif.mp4</code> sitting right where you intended. It'll be much smaller in size, and will play perfectly fine.</p>\n<p>Just replace</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #ABB2BF\">&lt;</span><span style=\"color: #E06C75\">img</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">src</span><span style=\"color: #ABB2BF\">=</span><span style=\"color: #98C379\">\"harry-eats-cupcake.gif\"</span><span style=\"color: #ABB2BF\"> /&gt;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>with</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #ABB2BF\">&lt;</span><span style=\"color: #E06C75\">video</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">autoplay</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">loop</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">muted</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">playsinline</span><span style=\"color: #ABB2BF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  &lt;</span><span style=\"color: #E06C75\">source</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">src</span><span style=\"color: #ABB2BF\">=</span><span style=\"color: #98C379\">\"vidgif.mp4\"</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">type</span><span style=\"color: #ABB2BF\">=</span><span style=\"color: #98C379\">\"video/mp4\"</span><span style=\"color: #ABB2BF\"> /&gt;</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  Your browser doesn't support HTML5 video playback.</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  &lt;</span><span style=\"color: #E06C75\">a</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">href</span><span style=\"color: #ABB2BF\">=</span><span style=\"color: #98C379\">\"harry-eats-cupcake.gif\"</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">target</span><span style=\"color: #ABB2BF\">=</span><span style=\"color: #98C379\">\"_blank\"</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">rel</span><span style=\"color: #ABB2BF\">=</span><span style=\"color: #98C379\">\"noopener\"</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    &gt;See the gif here&lt;/</span><span style=\"color: #E06C75\">a</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  &gt;</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">&lt;/</span><span style=\"color: #E06C75\">video</span><span style=\"color: #ABB2BF\">&gt;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Now this will play just like GIF! <code>playsinline</code> is necessary for it to run automatically on IOS Safari, and is also good for performance.</p>\n<p>But wait! There's a catch!</p>\n<p>If you push this file to production, and try to view it on Android or IOS, you'll see a blank area where the GIF should be visible. Why?</p>\n<h1 id=\"Compatibility\"><a class=\"heading-link\" href=\"/blog/gif-to-mp4-ffmpeg-fluent-web#Compatibility\">#</a>Compatibility</h1>\n<p>The code above doesn't encode the new MP4 video for maximum compatibility.</p>\n<p>The file you generated will work fine on a computer which comes with all kinds of codecs preinstalled. But your phone's browser won't be able to parse the video file.</p>\n<h1 id=\"Solution\"><a class=\"heading-link\" href=\"/blog/gif-to-mp4-ffmpeg-fluent-web#Solution\">#</a>Solution</h1>\n<p>Remember the code snippet on top? Here it is again <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘‡\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f447.svg\"></p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #ABB2BF\">ffmpeg </span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">i harry</span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">eats</span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">cupcake.gif </span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">pix_fmt yuv420p </span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">c:v libx264 </span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">movflags </span><span style=\"color: #56B6C2\">+</span><span style=\"color: #ABB2BF\">faststart </span><span style=\"color: #56B6C2\">-</span><span style=\"color: #ABB2BF\">filter:v crop</span><span style=\"color: #56B6C2\">=</span><span style=\"color: #98C379\">'floor(in_w/2)*2:floor(in_h/2)*2'</span><span style=\"color: #ABB2BF\"> output.mp4</span></span>\n<span class=\"line\"></span></code></pre>\n<p>This code snippet works perfectly. The output.mp4 here works on phones too. But how do we translate it to <code>fluent-ffmpeg</code> format <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ¤”\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f914.svg\">?</p>\n<p><code>fluent-ffmpeg</code> has an <code>outputOptions</code> method which takes in an array of the all the output options. Simply put, every option after the <code>-i inputFile.gif</code> is an <code>outputOption</code>.</p>\n<p>Here's the code</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #E06C75\">ffmpeg</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">input</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">gifPath</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">outputOptions</span><span style=\"color: #ABB2BF\">([</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #98C379\">\"-pix_fmt yuv420p\"</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #98C379\">\"-c:v libx264\"</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #98C379\">\"-movflags +faststart\"</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #98C379\">\"-filter:v crop='floor(in_w/2)*2:floor(in_h/2)*2'\"</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  ])</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">noAudio</span><span style=\"color: #ABB2BF\">()</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">output</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">`vidgif.mp4`</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">on</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"end\"</span><span style=\"color: #ABB2BF\">, () </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"Ended\"</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  })</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">on</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"error\"</span><span style=\"color: #ABB2BF\">, (</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">))</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">run</span><span style=\"color: #ABB2BF\">();</span></span>\n<span class=\"line\"></span></code></pre>\n<ul>\n<li>output mp4 is encoded with h264, support Firefox/Chrome/Safari in Windows, Mac OSX, Android, and iOS.</li>\n<li>one mp4 file for all platforms, there is no need to encode an extra <code>webm</code> movie, which encoding speed is pretty slow.</li>\n<li>format as <code>yuv420p</code> for Firefox compatibility, the downside is color becomes less-saturate than original gif.</li>\n<li>yuv420p only support even width/height, so crop filter is required</li>\n<li><code>-movflags +faststart</code> flags are optimized for online view in browser</li>\n<li>compression ratio typically 10:1, pretty awesome. note that if original gif is &lt; 512KB, convert as mp4 is less efficient.</li>\n</ul>\n<p><a href=\"https://gist.github.com/ingramchen/e2af352bf8b40bb88890fba4f47eccd0\" target=\"_blank\" rel=\"noopener\">Courtesy of this gist</a></p>\n<h1 id=\"Complete-Code\"><a class=\"heading-link\" href=\"/blog/gif-to-mp4-ffmpeg-fluent-web#Complete-Code\">#</a>Complete Code</h1>\n<p>JS:</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">ffmpegInstaller</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"@ffmpeg-installer/ffmpeg\"</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">ffprobe</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"@ffprobe-installer/ffprobe\"</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">ffmpeg</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"fluent-ffmpeg\"</span><span style=\"color: #ABB2BF\">)()</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">setFfprobePath</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E5C07B\">ffprobe</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">path</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">setFfmpegPath</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E5C07B\">ffmpegInstaller</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">path</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #E06C75\">ffmpeg</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">input</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">gifPath</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">outputOptions</span><span style=\"color: #ABB2BF\">([</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #98C379\">\"-pix_fmt yuv420p\"</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #98C379\">\"-c:v libx264\"</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #98C379\">\"-movflags +faststart\"</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #98C379\">\"-filter:v crop='floor(in_w/2)*2:floor(in_h/2)*2'\"</span><span style=\"color: #ABB2BF\">,</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  ])</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">noAudio</span><span style=\"color: #ABB2BF\">()</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">output</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">`vidgif.mp4`</span><span style=\"color: #ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">on</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"end\"</span><span style=\"color: #ABB2BF\">, () </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"Ended\"</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  })</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">on</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">\"error\"</span><span style=\"color: #ABB2BF\">, (</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">))</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  .</span><span style=\"color: #61AFEF\">run</span><span style=\"color: #ABB2BF\">();</span></span>\n<span class=\"line\"></span></code></pre>\n<p>HTML:</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #ABB2BF\">&lt;</span><span style=\"color: #E06C75\">video</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">autoplay</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">loop</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">muted</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">playsinline</span><span style=\"color: #ABB2BF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  &lt;</span><span style=\"color: #E06C75\">source</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">src</span><span style=\"color: #ABB2BF\">=</span><span style=\"color: #98C379\">\"vidgif.mp4\"</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">type</span><span style=\"color: #ABB2BF\">=</span><span style=\"color: #98C379\">\"video/mp4\"</span><span style=\"color: #ABB2BF\"> /&gt;</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  Your browser doesn't support HTML5 video playback.</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  &lt;</span><span style=\"color: #E06C75\">a</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">href</span><span style=\"color: #ABB2BF\">=</span><span style=\"color: #98C379\">\"harry-eats-cupcake.gif\"</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">target</span><span style=\"color: #ABB2BF\">=</span><span style=\"color: #98C379\">\"_blank\"</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">rel</span><span style=\"color: #ABB2BF\">=</span><span style=\"color: #98C379\">\"noopener\"</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    &gt;See the gif here&lt;/</span><span style=\"color: #E06C75\">a</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  &gt;</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">&lt;/</span><span style=\"color: #E06C75\">video</span><span style=\"color: #ABB2BF\">&gt;</span></span>\n<span class=\"line\"></span></code></pre>\n","id":"gif-to-mp4-ffmpeg-fluent-web","reading_time":5.265,"toc":[{"indent":0,"id":"","title":"How to convert","length":14},{"indent":0,"id":"","title":"Install dependencies","length":20},{"indent":0,"id":"","title":"Code","length":4},{"indent":0,"id":"","title":"Compatibility","length":13},{"indent":0,"id":"","title":"Solution","length":8},{"indent":0,"id":"","title":"Complete Code","length":13}]}