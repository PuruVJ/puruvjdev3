{"title":"Simple code with fs.promises and async await","description":"If you've spent some time with Node's fs API, you know how huge a pain its callback based pattern can get. Read out how to flatten your code using promises and async await syntax","date":"11 Jan 2021, 12:07 PM","cover_image":"media/fs-promise-requires.jpg","body":"<p><img src=\"\" alt=\"\" class=\"feature-image\" style=\"display: none;\"></p><div class=\"picture-container\">\n  <figure style=\"width: 100%;--padding-top: 66.66666666666666%;\">\n    <picture>\n      <source type=\"image/jpg\" media=\"(min-width: 501px)\" data-srcset=\"../media/fs-promise-requires/large.jpg\">\n      <source type=\"image/jpg\" media=\"(max-width: 500px)\" data-srcset=\"../media/fs-promise-requires/small.jpg\">\n      <img alt=\"Placeholder\" data-src=\"../media/fs-promise-requires/large.jpg\" class=\"lazyload blog-img\">\n    </picture>\n  </figure>\n  </div><p></p>\n<p>Hi! I see you have jumped onto my blog. Well, buckle up, this is gonna be one helluva ride!! We're gonna explore how to use the all-time favorite <mark>async / await</mark> feature with Node's Filesystem API.</p>\n<p>So now, let's make a super-simple program to read the username and password from a file, encrypt the password(Always do it, kids <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜‰\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f609.svg\">), and write the username and new password to some other file.</p>\n<p>So let's write up in plain english how our code works</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #E06C75\">1.</span><span style=\"color: #ABB2BF\"> Read the </span><span style=\"color: #98C379\">`user-data.json`</span><span style=\"color: #ABB2BF\"> file.</span></span>\n<span class=\"line\"><span style=\"color: #E06C75\">2.</span><span style=\"color: #ABB2BF\"> Throw error if any.</span></span>\n<span class=\"line\"><span style=\"color: #E06C75\">3.</span><span style=\"color: #ABB2BF\"> Extract </span><span style=\"color: #98C379\">`username`</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #98C379\">`password`</span><span style=\"color: #ABB2BF\"> from the file contents.</span></span>\n<span class=\"line\"><span style=\"color: #E06C75\">4.</span><span style=\"color: #ABB2BF\"> Encrypt the password.</span></span>\n<span class=\"line\"><span style=\"color: #E06C75\">5.</span><span style=\"color: #ABB2BF\"> Assemble final data to be written into the new file.</span></span>\n<span class=\"line\"><span style=\"color: #E06C75\">6.</span><span style=\"color: #ABB2BF\"> Write the data to the </span><span style=\"color: #98C379\">`user-data-final.json`</span><span style=\"color: #ABB2BF\"> file</span></span>\n<span class=\"line\"><span style=\"color: #E06C75\">7.</span><span style=\"color: #ABB2BF\"> Throw error if any.</span></span>\n<span class=\"line\"><span style=\"color: #E06C75\">8.</span><span style=\"color: #ABB2BF\"> Output if successful</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Seems straightforward enough. So let's write it out in actual code.</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'fs'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">function</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">main</span><span style=\"color: #ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">readFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data.json'</span><span style=\"color: #ABB2BF\">, (</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #C678DD\">if</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">throw</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #7F848E\">// Let's process the data</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">username</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">password</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">JSON</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #56B6C2\">parse</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #7F848E\">// Let's encrypt</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">encryptedPassword</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">encrypt</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">password</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">finalObject</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E06C75\">username</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">password</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E06C75\">encryptedPassword</span><span style=\"color: #ABB2BF\"> };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #7F848E\">// Let's write it to another file</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">writeFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data-final.json'</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #D19A66\">JSON</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #56B6C2\">stringify</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">finalObject</span><span style=\"color: #ABB2BF\">), (</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">      </span><span style=\"color: #C678DD\">if</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">throw</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">      </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'Successful'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    });</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  });</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">try</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #61AFEF\">main</span><span style=\"color: #ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">} </span><span style=\"color: #C678DD\">catch</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">error</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>We're just catching the errors and throwing them out to the console, in the last <code>try-catch</code> block.</p>\n<p>This seems to work.</p>\n<p>But something nags me here. Look at the steps I wrote out in plain english, and then look at the code. Plain english steps look very sequential, and step by step. Whereas the code we wrote, it <strong>is</strong> sequential, but it feels like all the steps live inside step 1, and step 7 and 8 live inside step 6. In short:</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #abb2bf\">1.\n  2.\n  3.\n  4.\n  5.\n  6.\n    7.\n    8.\n</span></span></code></pre>\n<p>Doesn't feel so idiomatic anymore, does it? It feels weird that all these steps in the code have to live <strong>inside</strong> of other steps, whereas in what we wrote, it feels idiomatic, like passing the torch in olympics(or in whatever events the torch is passed, I ain't a sports junkie <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f601.svg\">).</p>\n<p>How can I make the code idiomatic, and mirror the steps it's based on?</p>\n<h1 id=\"Solution(s)\"><a class=\"heading-link\" href=\"/blog/fs-promises#Solution(s)\">#</a>Solution(s)</h1>\n<p>Well, callback pattern can be replaced by using <code>async / await</code>. We can flatten our code a lot using them. But <code>await</code> works only with promises, ie.</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">result</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">fetch</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'https://api.example.com'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span></code></pre>\n<p><code>fetch</code> here returns a promise, so we can await the result. How do we promisify our <code>writeFile</code> and <code>readFile</code> methods then <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ¤”\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f914.svg\">?</p>\n<p>Well, look at this code below:</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">readFile</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">path</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">new</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">Promise</span><span style=\"color: #ABB2BF\">((</span><span style=\"color: #E06C75\">resolve</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">reject</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">readFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">path</span><span style=\"color: #ABB2BF\">, (</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">      </span><span style=\"color: #C678DD\">if</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #61AFEF\">reject</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">      </span><span style=\"color: #61AFEF\">resolve</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    })</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  );</span></span>\n<span class=\"line\"></span></code></pre>\n<p>This is a promise based implementation of the readFile function. We can use it as simply as this <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘‡\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f447.svg\"></p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">data</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">readFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data.json'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span></code></pre>\n<p>This will read the file, and move on to the next line after the data has come through. No indentation, no branching, nothing, Nada!! It looks good. So let's implement our complete code with this method.</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'fs'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">readFile</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">path</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">new</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">Promise</span><span style=\"color: #ABB2BF\">((</span><span style=\"color: #E06C75\">resolve</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">reject</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">readFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">path</span><span style=\"color: #ABB2BF\">, (</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">      </span><span style=\"color: #C678DD\">if</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #61AFEF\">reject</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">      </span><span style=\"color: #61AFEF\">resolve</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    })</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  );</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">writeFile</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">path</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">new</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">Promise</span><span style=\"color: #ABB2BF\">((</span><span style=\"color: #E06C75\">resolve</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">reject</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    </span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">writeFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">path</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">, (</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #C678DD\">=&gt;</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">      </span><span style=\"color: #C678DD\">if</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">) </span><span style=\"color: #61AFEF\">reject</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">err</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">      </span><span style=\"color: #61AFEF\">resolve</span><span style=\"color: #ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">    })</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  );</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">async</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">function</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">main</span><span style=\"color: #ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">data</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">readFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data.json'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Extract</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">username</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">password</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">JSON</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #56B6C2\">parse</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Let's encrypt</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">encryptedPassword</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">encrypt</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">password</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">finalObject</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E06C75\">username</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">password</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E06C75\">encryptedPassword</span><span style=\"color: #ABB2BF\"> };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Let's write to another file</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">writeFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data-final.json'</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #D19A66\">JSON</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #56B6C2\">stringify</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">finalObject</span><span style=\"color: #ABB2BF\">));</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'Successful'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">try</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #61AFEF\">main</span><span style=\"color: #ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">} </span><span style=\"color: #C678DD\">catch</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">error</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Look at our main function here. The overall code is bigger, but our <code>main</code> function, which is the actual logic, is much more simpler and actually follows the steps we wrote, in the idiomatic way we imagined.</p>\n<h2 id=\"Simpler-way-(utils.promisify)...\"><a class=\"heading-link\" href=\"/blog/fs-promises#Simpler-way-(utils.promisify)...\">#</a>Simpler way (utils.promisify)...</h2>\n<p>Our code above looks quite big, due to defining the promise-based versions of <code>writeFile</code> and <code>readFile</code>. We can make it much, much smaller by using a utility function exported by Node itself, <code>promisify</code>.</p>\n<p>Usage <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘‡\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f447.svg\"></p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">promisify</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'util'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'fs'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">writeFile</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">promisify</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">writeFile</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span></code></pre>\n<p>You simply pass the callback-based function to the <code>promisify</code> function, and voila! you have a promise-based version of your original function.</p>\n<p>So our code now becomes <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘‡\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f447.svg\"></p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">promisify</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'util'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'fs'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">writeFile</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">promisify</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">writeFile</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">readFile</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">promisify</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">readFile</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">async</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">function</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">main</span><span style=\"color: #ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">data</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">readFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data.json'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Extract</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">username</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">password</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">JSON</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #56B6C2\">parse</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Let's encrypt</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">encryptedPassword</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">encrypt</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">password</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">finalObject</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E06C75\">username</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">password</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E06C75\">encryptedPassword</span><span style=\"color: #ABB2BF\"> };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Let's write to another file</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">writeFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data-final.json'</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #D19A66\">JSON</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #56B6C2\">stringify</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">finalObject</span><span style=\"color: #ABB2BF\">));</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'Successful'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">try</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #61AFEF\">main</span><span style=\"color: #ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">} </span><span style=\"color: #C678DD\">catch</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">error</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>So much smaller <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f60d.svg\">.</p>\n<h2 id=\"...Simplest-Way!\"><a class=\"heading-link\" href=\"/blog/fs-promises#...Simplest-Way!\">#</a>...Simplest Way!</h2>\n<p>Now lemme introduce you to the Ace in the sleeve! Since version 10, NodeJS exports promise based versions of its methods, <strong>by default</strong>. They can be accessed by <code>require('fs').promises</code>.</p>\n<p>Here's our final code using this approach:</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">writeFile</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">readFile</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'fs'</span><span style=\"color: #ABB2BF\">).</span><span style=\"color: #E06C75\">promises</span><span style=\"color: #ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">async</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">function</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">main</span><span style=\"color: #ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">data</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">readFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data.json'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Extract</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">username</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">password</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">JSON</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #56B6C2\">parse</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Let's encrypt</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">encryptedPassword</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">encrypt</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">password</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">finalObject</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E06C75\">username</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">password</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E06C75\">encryptedPassword</span><span style=\"color: #ABB2BF\"> };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Let's write to another file</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">writeFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data-final.json'</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #D19A66\">JSON</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #56B6C2\">stringify</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">finalObject</span><span style=\"color: #ABB2BF\">));</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'Successful'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">try</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #61AFEF\">main</span><span style=\"color: #ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">} </span><span style=\"color: #C678DD\">catch</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">error</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Notice the first line. We're directly importing the <code>writeFile</code> and <code>readFile</code> methods from <code>require(fs).promises</code>. This is the best and the cleanest version you can find in Node currently.</p>\n<h1 id=\"Code-Conventions\"><a class=\"heading-link\" href=\"/blog/fs-promises#Code-Conventions\">#</a>Code Conventions</h1>\n<p>Now that you've seen how to use <code>fs.promises</code>, let's find out the best patterns to use this code.</p>\n<h2 id=\"Importing-individual-functions\"><a class=\"heading-link\" href=\"/blog/fs-promises#Importing-individual-functions\">#</a>Importing individual functions</h2>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">writeFile</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">readFile</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">access</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'fs'</span><span style=\"color: #ABB2BF\">).</span><span style=\"color: #E06C75\">promises</span><span style=\"color: #ABB2BF\">;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>This is probably the most convenient method, and the cleanest too. But the problem arises when you have to import something from regular <code>fs</code> module. For example <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘‡\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f447.svg\"></p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">writeFile</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">readFile</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">access</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'fs'</span><span style=\"color: #ABB2BF\">).</span><span style=\"color: #E06C75\">promises</span><span style=\"color: #ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">writeFileSync</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">createReadStream</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">createWriteStream</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'fs'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span></code></pre>\n<p>We are importing the promise based functions, as well as some functions from regular <code>fs</code>, like streams. Now you can directly use it down in your main logic, but sometimes when the code in the file gets big enough, and I'm not exactly using await with the promise-based versions, it can get pretty confusing which method is coming from where, so I have to scroll all the way to the top to see the imports.</p>\n<p>This may not seem like a big problem, but I challenge you to write this code and comeback to it after 6 months. You'll be in the same dilemma <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜‚\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f602.svg\"></p>\n<h2 id=\"Importing-as-namespace\"><a class=\"heading-link\" href=\"/blog/fs-promises#Importing-as-namespace\">#</a>Importing as namespace</h2>\n<p>This is my most preferred method.</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">require</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'fs'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">fsp</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #E06C75\">promises</span><span style=\"color: #ABB2BF\">; </span><span style=\"color: #7F848E\">// <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘ˆ\" src=\"https://twemoji.maxcdn.com/v/13.1.0/svg/1f448.svg\"> This line</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">...</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">fsp</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">writeFile</span><span style=\"color: #ABB2BF\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #E5C07B\">fs</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">createReadStream</span><span style=\"color: #ABB2BF\">();</span></span>\n<span class=\"line\"></span></code></pre>\n<h2 id=\"ES-Imports\"><a class=\"heading-link\" href=\"/blog/fs-promises#ES-Imports\">#</a>ES Imports</h2>\n<p>Now that we can use ES Imports in Node(with some extra tweaking), let's consider the Modular version</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">import</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E06C75\">promises</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">as</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E06C75\">fsp</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #C678DD\">from</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #98C379\">'fs'</span><span style=\"color: #ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">async</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">function</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">main</span><span style=\"color: #ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">data</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">fsp</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">readFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data.json'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Extract</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">username</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">password</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">JSON</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #56B6C2\">parse</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Let's encrypt</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">encryptedPassword</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">encrypt</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">password</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">finalObject</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E06C75\">username</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">password</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E06C75\">encryptedPassword</span><span style=\"color: #ABB2BF\"> };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Let's write to another file</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">fsp</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">writeFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data-final.json'</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #D19A66\">JSON</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #56B6C2\">stringify</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">finalObject</span><span style=\"color: #ABB2BF\">));</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'Successful'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">try</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #61AFEF\">main</span><span style=\"color: #ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">} </span><span style=\"color: #C678DD\">catch</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">error</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Also, if your node version is more than <mark>v14.8.0</mark>, you can also directly use top level await (I have an article about it, <a href=\"https://puruvj.dev/blog/top-level-await\" target=\"_blank\" rel=\"noopener\">right here</a>).</p>\n<pre class=\"shiki\" style=\"background-color: #282c34\"><code><span class=\"line\"><span style=\"color: #C678DD\">import</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E06C75\">promises</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">as</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E06C75\">fsp</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #C678DD\">from</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #98C379\">'fs'</span><span style=\"color: #ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C678DD\">try</span><span style=\"color: #ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">data</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">fsp</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">readFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data.json'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Extract</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E5C07B\">username</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E5C07B\">password</span><span style=\"color: #ABB2BF\"> } </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #D19A66\">JSON</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #56B6C2\">parse</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">data</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Let's encrypt</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">encryptedPassword</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #61AFEF\">encrypt</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">password</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">const</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">finalObject</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #56B6C2\">=</span><span style=\"color: #ABB2BF\"> { </span><span style=\"color: #E06C75\">username</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #E06C75\">password</span><span style=\"color: #ABB2BF\">: </span><span style=\"color: #E06C75\">encryptedPassword</span><span style=\"color: #ABB2BF\"> };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #7F848E\">// Let's write to another file</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #C678DD\">await</span><span style=\"color: #ABB2BF\"> </span><span style=\"color: #E5C07B\">fsp</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">writeFile</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'user-data-final.json'</span><span style=\"color: #ABB2BF\">, </span><span style=\"color: #D19A66\">JSON</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #56B6C2\">stringify</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">finalObject</span><span style=\"color: #ABB2BF\">));</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">log</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #98C379\">'Successful'</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">} </span><span style=\"color: #C678DD\">catch</span><span style=\"color: #ABB2BF\"> (</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">  </span><span style=\"color: #E5C07B\">console</span><span style=\"color: #ABB2BF\">.</span><span style=\"color: #61AFEF\">error</span><span style=\"color: #ABB2BF\">(</span><span style=\"color: #E06C75\">e</span><span style=\"color: #ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"color: #ABB2BF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Even smaller!!!</p>\n<h1 id=\"Conclusion\"><a class=\"heading-link\" href=\"/blog/fs-promises#Conclusion\">#</a>Conclusion</h1>\n<p>Hope you got some good insights from this blog post.</p>\n","id":"fs-promises","reading_time":9.745,"toc":[{"indent":0,"id":"","title":"Solution(s)","length":11},{"indent":1,"id":"","title":"Simpler way (utils.promisify)...","length":32},{"indent":1,"id":"","title":"...Simplest Way!","length":16},{"indent":0,"id":"","title":"Code Conventions","length":16},{"indent":1,"id":"","title":"Importing individual functions","length":30},{"indent":1,"id":"","title":"Importing as namespace","length":22},{"indent":1,"id":"","title":"ES Imports","length":10},{"indent":0,"id":"","title":"Conclusion","length":10}]}