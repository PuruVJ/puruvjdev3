{"title":"The Zen of Preact's source code","description":"Dive into Preact's source code and explore its simplicity","date":"1 May, 2021","cover_image":"media/deep-dive-preact-source--cover.jpg","body":"<p><img src=\"\" alt=\"\" class=\"feature-image\" style=\"display: none;\"></p><div class=\"picture-container\">\n  <figure style=\"width: 100%;padding-top: 75%;\">\n    <picture>\n      <source type=\"image/jpg\" media=\"(min-width: 501px)\" data-srcset=\"/media/deep-dive-preact-source--cover/large.jpg\">\n      <source type=\"image/jpg\" media=\"(max-width: 500px)\" data-srcset=\"/media/deep-dive-preact-source--cover/small.jpg\">\n      <img alt=\"Placeholder\" data-src=\"/media/deep-dive-preact-source--cover/large.jpg\" class=\"lazyload blog-img\">\n    </picture>\n  </figure>\n  </div><p></p>\n<blockquote>\n<p><em>Artwork by <a href=\"https://unsplash.com/photos/GxymWkdnl4Y\" target=\"_blank\" rel=\"noopener\">Fernando Jorge</a></em></p>\n</blockquote>\n<p>Preact is [web dev]household name at this point. Almost every web developer who's been in this business for longer than 2 years has heard of it and maybe even tried it themselves. And probably reached the same conclusion as me: <strong>It's awesome!! <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜»\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f63b.svg\"></strong>.</p>\n<p>So today, I'm gonna do a deep dive into Preact's source code, and remark on some interesting things I find there.</p>\n<h1 id=\"What-is-Preact\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#What-is-Preact\">#</a>What is Preact?</h1>\n<p>In case you're not familiar, Preact is the <code>3KB</code> alternative to the <code>42KB</code> of React, by <a href=\"https://twitter.com/_developit\" target=\"_blank\" rel=\"noopener\">Jason Miller</a>. It's fully compatible with React's API and supports all packages that rely on React. Its awesome that way.</p>\n<h1 id=\"Observations\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#Observations\">#</a>Observations</h1>\n<p>Before we look at the code, I'll remark on some things about Preact.</p>\n<h2 id=\"Written-in-TypeScript-but-not-quite...\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#Written-in-TypeScript-but-not-quite...\">#</a>Written in TypeScript, but not quite...</h2>\n<p>Preact's source code is written in TypeScript, but the main files themselves aren't. The main files with the functionality are written in plain JavaScript, but they use <code>JSDoc</code> to pull in Types from TypeScript Definition files (.d.ts).</p>\n<p>An example:</p>\n<p>This is the <code>types.d.ts</code> file:</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">type</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #FFCB6B\">RenamedType</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #FFCB6B\">number</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">|</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #FFCB6B\">null</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>And here's the JS file</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #676E95\">/**</span></span>\n<span class=\"line\"><span style=\"color: #676E95\"> * </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">param</span><span style=\"color: #676E95\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #FFCB6B\">import('./types').RenamedType</span><span style=\"color: #89DDFF\">}</span><span style=\"color: #676E95\"> </span><span style=\"color: #A6ACCD\">a</span></span>\n<span class=\"line\"><span style=\"color: #676E95\"> * </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">param</span><span style=\"color: #676E95\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #FFCB6B\">import('./types').RenamedType</span><span style=\"color: #89DDFF\">}</span><span style=\"color: #676E95\"> </span><span style=\"color: #A6ACCD\">b</span></span>\n<span class=\"line\"><span style=\"color: #676E95\"> * </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">returns</span></span>\n<span class=\"line\"><span style=\"color: #676E95\"> */</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">sum</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">a</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> b</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">a</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">b</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>As you can see, the JavaScript code is just that: JavaScript. You won't see TypeScript style type specified in it. Rather all type information is specified in comments, which are ignored completely. There's a whole article about <a href=\"https://puruvj.dev/blog/get-to-know-typescript--using-typescript-without-typescript\" target=\"_blank\" rel=\"noopener\">Using TypeScript without TypeScript</a>, but the TLDR; here would be: Avoid development time tooling. If its just plain JS, you don't need to run a file watcher to transpile files as you change them. Just run what you got. And you already got a TypeScript compiler running all the time without you explicitly running it: Your VSCode.</p>\n<p>This is a very interesting approach and I see more and more libraries take it up, especially non-UI libraries(For UI libraries, you already got a web server running, so adding in TypeScript in the tooling won't change much, go ahead and add TypeScript)</p>\n<h2 id=\"Very-well-written-code\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#Very-well-written-code\">#</a>Very well written code</h2>\n<p>I don't need to say this out loud really, but Preact's source code is very very well written and commented, as you'd expect from such a paramount framework.</p>\n<h2 id=\"It-reuses-itself-a-lot\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#It-reuses-itself-a-lot\">#</a>It reuses itself a lot</h2>\n<p>Yup. One of the reasons Preact is so small is that it reuses it's own exported function in its other exported functions. A LOTT!! I'll show you some places where this happens</p>\n<h1 id=\"Disclaimer\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#Disclaimer\">#</a>Disclaimer</h1>\n<p>This is not gonna be a complete breakdown, and won't be sequential. Preact is quite a big library to cover in a blog post, so I'll just cover the interesting parts.</p>\n<p>So, let's begin!! We'll look at some interesting things in the <code>core</code> module(i.e., the one when you type <code>import {} from 'preact'</code>), then we'll get to hooks</p>\n<h1 id=\"Core-module\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#Core-module\">#</a>Core module</h1>\n<h2 id=\"index.js\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#index.js\">#</a>index.js</h2>\n<p>As is the tradition, let's start with the <code>index.js</code> file:</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">render</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">hydrate</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">}</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">from</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">./render</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">createElement</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">createElement</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">as</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">h</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">Fragment</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">createRef</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">isValidElement</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">from</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">./create-element</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">Component</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">}</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">from</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">./component</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">cloneElement</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">}</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">from</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">./clone-element</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">createContext</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">}</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">from</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">./create-context</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">toChildArray</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">}</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">from</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">./diff/children</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">default</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">as</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">options</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">}</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">from</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">./options</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Notable points: <code>h</code>, which is Preact's JSX factory, is actually named <code>createElement</code>. Just like <code>React.createElement</code>. But is exported as <code>h</code> because it allows you to write raw Preact(Without JSX), also because it was initially inspired from <a href=\"https://github.com/hyperhype/hyperscript\" target=\"_blank\" rel=\"noopener\">HyperScript</a> <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘‡\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f447.svg\"></p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #82AAFF\">h</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">div</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #F07178\">class</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">haha</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">},</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">h</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">span</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #F07178\">key</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #F78C6C\">34</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">},</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">h</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">h1</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{},</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">h</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">span</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{},</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">Whoa</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #A6ACCD\">))))</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Also it is notable that it exports <code>createElement</code> as it is too, to maintain compatibility with <code>React.createElement</code></p>\n<h2 id=\"create-element.js\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#create-element.js\">#</a>create-element.js</h2>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">import</span><span style=\"color: #A6ACCD\"> options </span><span style=\"color: #89DDFF\">from</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">./options</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">createElement</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">type</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> props</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> children</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #676E95\">/*...*/</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">createVNode</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">type</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> props</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> key</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> ref</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> original</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #676E95\">/*...*/</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">createRef</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #F07178\"> current</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">null</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">};</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">Fragment</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">props</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">props</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">children</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">const</span><span style=\"color: #A6ACCD\"> isValidElement </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">vnode</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #A6ACCD\"> vnode </span><span style=\"color: #89DDFF\">!=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">null</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">&amp;&amp;</span><span style=\"color: #A6ACCD\"> vnode</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">constructor </span><span style=\"color: #89DDFF\">===</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">undefined;</span></span>\n<span class=\"line\"></span></code></pre>\n<blockquote>\n<p>Omitted <code>createElement</code> and <code>createVNode</code> as they're quite big.</p>\n</blockquote>\n<h3 id=\"createRef\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#createRef\">#</a>createRef</h3>\n<p>Let me blow your mind. <code>ref</code>s in P/React are basically used to encapsulate values that shouldn't trigger re-renders and are not re-created on every re-render. Lets see how Preact defines it:</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">createRef</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #F07178\"> current</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">null</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">};</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>A ref is just an object with <code>current</code> property set to <code>null</code>. It's always advertised as that, but I never thought that it's <strong>actually</strong> an object internally too.</p>\n<p>A little clip of me when I found this out <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘‡\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f447.svg\"></p>\n<p><img src=\"\" alt=\"\" class=\"feature-image\" style=\"display: none;\"></p><div class=\"picture-container\">\n  <div class=\"gif-vid-container\">\n    <video autoplay=\"\" loop=\"\" muted=\"\" playsinline=\"\">\n      <source src=\"/media/deep-dive-preact-source--astonished-cat/vidgif.mp4\" type=\"video/mp4\">\n      Your browser doesn't support HTML5 video playback. <a href=\"/media/deep-dive-preact-source--astonished-cat.gif\" target=\"_blank\" rel=\"noopener\">See the gif here</a>\n    </video>\n  </div>\n  </div><p></p>\n<h3 id=\"Fragment\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#Fragment\">#</a>Fragment</h3>\n<p>Next up, we have <code>Fragment</code>. Its also another astonishing thing.</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">Fragment</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">props</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">props</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">children</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Fragment, just returns its <code>children</code>. That's all! <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ¤¯\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f92f.svg\"><img class=\"emoji\" draggable=\"false\" alt=\"ðŸ¤¯\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f92f.svg\"></p>\n<p>I knew that's what it's <strong>supposed</strong> to do, but I always pictured some complex code. Didn't realise that it was just this super simple thing.</p>\n<h3 id=\"isValidElement\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#isValidElement\">#</a>isValidElement</h3>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #676E95\">/**</span></span>\n<span class=\"line\"><span style=\"color: #676E95\"> * Check if a the argument is a valid Preact VNode.</span></span>\n<span class=\"line\"><span style=\"color: #676E95\"> * </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">param</span><span style=\"color: #676E95\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #FFCB6B\">*</span><span style=\"color: #89DDFF\">}</span><span style=\"color: #676E95\"> </span><span style=\"color: #A6ACCD\">vnode</span></span>\n<span class=\"line\"><span style=\"color: #676E95\"> * </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">returns</span><span style=\"color: #676E95\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #FFCB6B\">vnode is import('./internal').VNode</span><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"><span style=\"color: #676E95\"> */</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">const</span><span style=\"color: #A6ACCD\"> isValidElement </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">vnode</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #A6ACCD\"> vnode </span><span style=\"color: #89DDFF\">!=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">null</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">&amp;&amp;</span><span style=\"color: #A6ACCD\"> vnode</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">constructor </span><span style=\"color: #89DDFF\">===</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">undefined;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Simply checking if the current Virtual DOM Node passed to it is valid or not. Again, one liner, super small, but here's a pattern I found out by looking at this code only. Notice <code>@returns {vnode is import('./internal').VNode}</code> in JSDoc. The code is basically using type guards. Right in the JSDoc. I haven't seen this pattern before, which is all the more proof that reading code written by those smarter than you can make you a better dev.</p>\n<h2 id=\"render.js\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#render.js\">#</a>render.js</h2>\n<p>Remember the index.jsx file, where you initialize your <mark>Preact</mark> app</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">import</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">render</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">h</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">}</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">from</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">preact</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">import</span><span style=\"color: #A6ACCD\"> App </span><span style=\"color: #89DDFF\">from</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">./App</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">render</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #FFCB6B\">App</span><span style=\"color: #89DDFF\"> /&gt;,</span><span style=\"color: #A6ACCD\"> document</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">querySelector</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">#app</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #A6ACCD\">))</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>This is the <code>render</code> function <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘‡\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f447.svg\"></p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">render</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">vnode</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> parentDom</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> replaceNode</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #A6ACCD\">options</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_root</span><span style=\"color: #F07178\">) </span><span style=\"color: #A6ACCD\">options</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">_root</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">vnode</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">parentDom</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// We abuse the `replaceNode` parameter in `hydrate()` to signal if we are in</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// hydration mode or not by passing the `hydrate` function instead of a DOM</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// element..</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">let</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">isHydrating</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">typeof</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">replaceNode</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">===</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">function</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// To be able to support calling `render()` multiple times on the same</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// DOM node, we need to obtain a reference to the previous tree. We do</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// this by assigning a new `_children` property to DOM nodes which points</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// to the last rendered tree. By default this property is not present, which</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// means that we are mounting a new tree for the first time.</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">let</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">oldVNode</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">isHydrating</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">?</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">null</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">:</span><span style=\"color: #F07178\"> (</span><span style=\"color: #A6ACCD\">replaceNode</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">&amp;&amp;</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">replaceNode</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_children</span><span style=\"color: #F07178\">) </span><span style=\"color: #89DDFF\">||</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">parentDom</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_children</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">vnode</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> ((</span><span style=\"color: #89DDFF\">!</span><span style=\"color: #A6ACCD\">isHydrating</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">&amp;&amp;</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">replaceNode</span><span style=\"color: #F07178\">) </span><span style=\"color: #89DDFF\">||</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">parentDom</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_children</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">createElement</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">Fragment</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">null,</span><span style=\"color: #F07178\"> [</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">vnode</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  ])</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// List of effects that need to be called after diffing.</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">let</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">commitQueue</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> []</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #82AAFF\">diff</span><span style=\"color: #F07178\">(</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">parentDom</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">    </span><span style=\"color: #676E95\">// Determine the new vnode tree and store it on the DOM element on</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">    </span><span style=\"color: #676E95\">// our custom `_children` property.</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">vnode</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">oldVNode</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">||</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">EMPTY_OBJ</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">EMPTY_OBJ</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">parentDom</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">ownerSVGElement</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">!==</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">undefined,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #89DDFF\">!</span><span style=\"color: #A6ACCD\">isHydrating</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">&amp;&amp;</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">replaceNode</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">?</span><span style=\"color: #F07178\"> [</span><span style=\"color: #A6ACCD\">replaceNode</span><span style=\"color: #F07178\">]</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">:</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">oldVNode</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">?</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">null</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">:</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">parentDom</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">firstChild</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">?</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">EMPTY_ARR</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">slice</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">call</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">parentDom</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">childNodes</span><span style=\"color: #F07178\">)</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">:</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">null,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">commitQueue</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #89DDFF\">!</span><span style=\"color: #A6ACCD\">isHydrating</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">&amp;&amp;</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">replaceNode</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">?</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">replaceNode</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">:</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">oldVNode</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">?</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">oldVNode</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_dom</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">:</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">parentDom</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">firstChild</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">isHydrating</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  )</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// Flush all queued effects</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #82AAFF\">commitRoot</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">commitQueue</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">vnode</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">hydrate</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">vnode</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> parentDom</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #82AAFF\">render</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">vnode</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">parentDom</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">hydrate</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>First off, <strong>very well commented</strong>.</p>\n<p>From how well I can make sense of the situation here, <code>render</code> function is basically making a <code>commitQueue</code> to store all the changes needed to be done. next, the <code>diff</code> function is taking in the old VNode and the new VNode, making sense of situation and figuring out which DOM Nodes need to be updated, and populating <code>commitQueue</code>.</p>\n<p>Then its basically <code>committing</code> these changes. Its just like how we do it in Database. We perform some operation in batch, the commit, so they all get applied one by one at the same time.</p>\n<blockquote>\n<p>I would love to cover <code>diff</code> in the blog post too, but its so big it has its own <strong>500 lines</strong> long file <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜µ\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f635.svg\">. All you have to know, its job is to figure out which DOM Nodes need to be updated and which to keep the same.</p>\n</blockquote>\n<h3 id=\"hydrate\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#hydrate\">#</a>hydrate</h3>\n<p>This function is very interesting, as it nothing but calling the <code>render</code> function. But something even more interesting, its passing along <strong>itself</strong> as the 3rd argument. And if you look again at <code>render</code> function, it actually has an if condition looking if the function passed to it is named <code>hydrate</code>. Heck there's even a comment about <code>abusing</code> the 3rd argument <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜‚\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f602.svg\">. These people are way too smart!!</p>\n<p>I'm probably exhausting my repeat limit, but darn!! Preact's reuse of itself is really, darn good!!!</p>\n<h2 id=\"create-context.js\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#create-context.js\">#</a>create-context.js</h2>\n<p>This one will probably excite you, as Context is a very, very loved API by a majority of P/React developers. This wasn't always the case, but the <code>useContext</code> hooks made it very easy to use context. Way too easy!!</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #C792EA\">const</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #A6ACCD\"> lemonsCount</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> setLemonsCount </span><span style=\"color: #89DDFF\">}</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useContext</span><span style=\"color: #A6ACCD\">(lemonsContext)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span></code></pre>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">import</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">enqueueRender</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">}</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">from</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">./component</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">let</span><span style=\"color: #A6ACCD\"> i </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">createContext</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">defaultValue</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> contextId</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">contextId</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">'</span><span style=\"color: #C3E88D\">__cC</span><span style=\"color: #89DDFF\">'</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">i</span><span style=\"color: #89DDFF\">++;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">const</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    _id</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">contextId</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    _defaultValue</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">defaultValue</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #676E95\">/** </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">type</span><span style=\"color: #676E95\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #FFCB6B\">import('./internal').FunctionComponent</span><span style=\"color: #89DDFF\">}</span><span style=\"color: #676E95\"> */</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    Consumer</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">props</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">contextValue</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">props</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">children</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">contextValue</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #89DDFF\">},</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #676E95\">/** </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">type</span><span style=\"color: #676E95\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #FFCB6B\">import('./internal').FunctionComponent</span><span style=\"color: #89DDFF\">}</span><span style=\"color: #676E95\"> */</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    Provider</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">props</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #89DDFF\">!this.</span><span style=\"color: #A6ACCD\">getChildContext</span><span style=\"color: #F07178\">) </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">        </span><span style=\"color: #C792EA\">let</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">subs</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> []</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">        </span><span style=\"color: #C792EA\">let</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">ctx</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">{};</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">        </span><span style=\"color: #A6ACCD\">ctx</span><span style=\"color: #F07178\">[</span><span style=\"color: #A6ACCD\">contextId</span><span style=\"color: #F07178\">] </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">this;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">        </span><span style=\"color: #89DDFF\">this.</span><span style=\"color: #82AAFF\">getChildContext</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">()</span><span style=\"color: #F07178\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">ctx</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">        </span><span style=\"color: #89DDFF\">this.</span><span style=\"color: #82AAFF\">shouldComponentUpdate</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">_props</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">          </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #89DDFF\">this.</span><span style=\"color: #A6ACCD\">props</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">value</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">!==</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">_props</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">value</span><span style=\"color: #F07178\">) </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">            </span><span style=\"color: #A6ACCD\">subs</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">some</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">enqueueRender</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">          </span><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">        </span><span style=\"color: #89DDFF\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">        </span><span style=\"color: #89DDFF\">this.</span><span style=\"color: #82AAFF\">sub</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">c</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #F07178\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">          </span><span style=\"color: #A6ACCD\">subs</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">push</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">c</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">          </span><span style=\"color: #C792EA\">let</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">old</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">c</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">componentWillUnmount</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">          </span><span style=\"color: #A6ACCD\">c</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">componentWillUnmount</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">()</span><span style=\"color: #F07178\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">            </span><span style=\"color: #A6ACCD\">subs</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">splice</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">subs</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">indexOf</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">c</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">            </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #A6ACCD\">old</span><span style=\"color: #F07178\">) </span><span style=\"color: #A6ACCD\">old</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">call</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">c</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">          </span><span style=\"color: #89DDFF\">};</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">        </span><span style=\"color: #89DDFF\">};</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">props</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">children</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #89DDFF\">},</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// Devtools needs access to the context object when it</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// encounters a Provider. This is necessary to support</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// setting `displayName` on the context object instead</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// of on the component itself. See:</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// https://reactjs.org/docs/context.html#contextdisplayname</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> (</span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">Provider</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_contextRef</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">Consumer</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">contextType</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>This file, this small file, is all there's to the core context API. These 42 lines do so much(Comments excluded).</p>\n<p>So, let's inspect <code>Consumer</code>. Go back a long time back and remember we used to use <code>Consumer</code> to access context data.</p>\n<p>This is how it looks</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #FFCB6B\">Consumer</span><span style=\"color: #89DDFF\">&gt;{(</span><span style=\"color: #A6ACCD\">data</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">div</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #A6ACCD\">Hello </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #A6ACCD\">data</span><span style=\"color: #89DDFF\">}&lt;/</span><span style=\"color: #F07178\">div</span><span style=\"color: #89DDFF\">&gt;}&lt;/</span><span style=\"color: #FFCB6B\">Consumer</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>This looks pretty manageable, but it could get worse when your code grew.</p>\n<p>So, if we look at the code of <code>Consumer</code>, it's just this:</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #82AAFF\">Consumer</span><span style=\"color: #A6ACCD\">(props</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> contextValue) </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">props</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">children</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">contextValue</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">},</span></span>\n<span class=\"line\"></span></code></pre>\n<p>That's it!! Its expecting its <code>children</code> to be a function, and it's simply calling it with the context data. Suddenly the <code>Consumer</code> pattern example above makes sense <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ¤¯\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f92f.svg\"><img class=\"emoji\" draggable=\"false\" alt=\"ðŸ¤¯\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f92f.svg\">.</p>\n<p>As for <code>Provider</code>, what it's doing mostly is modifying its parent component's lifecycle hooks to watch for context state changes.</p>\n<p>Lastly, there's the <code>return</code> statement at the bottom. The last line is big mutation trick that is used often while coding classical languages like C, C++, Java etc, that is, returning a variable and mutating it at the same time. Here, it is mutating it for the sake of Preact devtools, so as to show the <code>displayName</code> in devtools, as React Devtools do.</p>\n<p>And now, its time for the section you probably came here for entirely: <strong>HOOKS!!</strong></p>\n<h1 id=\"Hooks\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#Hooks\">#</a>Hooks</h1>\n<p>So, first off, Hooks are located in a separate directory. Unlike React, everything is opt-in in Preact, which makes the Minimalist in me rejoice. There's intentionality in every thing you do here. I <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f60d.svg\"> that.</p>\n<p>So, let's start off with the very, very first hook you ever encountered: <code>useState</code></p>\n<blockquote>\n<p>But Beware, a twist lies here <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜ˆ\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f608.svg\"></p>\n</blockquote>\n<h2 id=\"useState\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#useState\">#</a>useState</h2>\n<p>This, is <code>useState</code>:</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useState</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">initialState</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">currentHook</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">useReducer</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">invokeOrReturn</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">initialState</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p><img src=\"\" alt=\"\" class=\"feature-image\" style=\"display: none;\"></p><div class=\"picture-container\">\n  <div class=\"gif-vid-container\">\n    <video autoplay=\"\" loop=\"\" muted=\"\" playsinline=\"\">\n      <source src=\"/media/deep-dive-preact-source--wait-what/vidgif.mp4\" type=\"video/mp4\">\n      Your browser doesn't support HTML5 video playback. <a href=\"/media/deep-dive-preact-source--wait-what.gif\" target=\"_blank\" rel=\"noopener\">See the gif here</a>\n    </video>\n  </div>\n  </div><p></p>\n<p>Mindblown right? As you can see, useState is basically calling <code>useReducer</code>, which is another standard React hook. So basically, <code>useState</code> is just an alias of <code>useReducer</code>, you could say.</p>\n<blockquote>\n<p>The variables <code>invokeOrReturn</code> and <code>currentHook</code> are defined in the same file, in the module scope and managed by Preact.</p>\n</blockquote>\n<p>And lemme give you another nugget. See the <code>currentHook = 1</code> expression? Guess what: It's not needed in the core functionality. It exists solely for <mark>Preact Devtools</mark>. That is, if Devtools weren't a consideration, this code might as well have been:</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #C792EA\">const</span><span style=\"color: #A6ACCD\"> useState </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">initialState</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useReducer</span><span style=\"color: #A6ACCD\">(invokeOrReturn</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> initialState)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Literally a one liner!! <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ¤¯\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f92f.svg\"><img class=\"emoji\" draggable=\"false\" alt=\"ðŸ¤¯\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f92f.svg\"><img class=\"emoji\" draggable=\"false\" alt=\"ðŸ¤¯\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f92f.svg\"><img class=\"emoji\" draggable=\"false\" alt=\"ðŸ¤¯\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f92f.svg\"></p>\n<p>Again, intense focus on the whole self-reusing thing I keep repeating.</p>\n<p>All the heavy lifting here is done by the <code>useReducer</code>, so let's look at it next.</p>\n<h2 id=\"useReducer\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#useReducer\">#</a>useReducer</h2>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useReducer</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">reducer</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> initialState</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> init</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #676E95\">/** </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">type</span><span style=\"color: #676E95\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #FFCB6B\">import('./internal').ReducerHookState</span><span style=\"color: #89DDFF\">}</span><span style=\"color: #676E95\"> */</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">const</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">hookState</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">getHookState</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">currentIndex</span><span style=\"color: #89DDFF\">++,</span><span style=\"color: #F07178\"> </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">hookState</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_reducer</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">reducer</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #89DDFF\">!</span><span style=\"color: #A6ACCD\">hookState</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_component</span><span style=\"color: #F07178\">) </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">hookState</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> [</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">!</span><span style=\"color: #A6ACCD\">init</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">?</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">invokeOrReturn</span><span style=\"color: #F07178\">(</span><span style=\"color: #89DDFF\">undefined,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">initialState</span><span style=\"color: #F07178\">) </span><span style=\"color: #89DDFF\">:</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">init</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">initialState</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">action</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #F07178\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">        </span><span style=\"color: #C792EA\">const</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">nextValue</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">hookState</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">_reducer</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">hookState</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\">[</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #F07178\">]</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">action</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">        </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #A6ACCD\">hookState</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\">[</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #F07178\">] </span><span style=\"color: #89DDFF\">!==</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">nextValue</span><span style=\"color: #F07178\">) </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">          </span><span style=\"color: #A6ACCD\">hookState</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> [</span><span style=\"color: #A6ACCD\">nextValue</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">hookState</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\">[</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #F07178\">]]</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">          </span><span style=\"color: #A6ACCD\">hookState</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_component</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">setState</span><span style=\"color: #F07178\">(</span><span style=\"color: #89DDFF\">{}</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">        </span><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">},</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    ]</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">hookState</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_component</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">currentComponent</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">hookState</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>I'll admit I don't fully understand what's going on here <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜…\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f605.svg\">, but something that caught my eye here: Look at the <code>hookState._value = [</code> declaration inside the <code>if</code> block. Its an array with 2 elements. 1st element is simply a value. 2nd one is a function.</p>\n<p>Wait a sec. 1st element a value, 2nd element a function...</p>\n<p>Holy smokes!!! Its the <code>[state, setState]</code> pair returned from <code>useState</code> <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜µ\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f635.svg\"><img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜µ\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f635.svg\"></p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #C792EA\">const</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">[</span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> setState</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useState</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #89DDFF\">Infinity</span><span style=\"color: #A6ACCD\">)</span><span style=\"color: #89DDFF\">;</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #676E95\">// <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜ˆ\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f608.svg\"></span></span>\n<span class=\"line\"></span></code></pre>\n<p>if that didn't blow your brains apart, I dunno what will.</p>\n<p>Next up: The 2nd most famous hook!</p>\n<h2 id=\"useEffect\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#useEffect\">#</a>useEffect</h2>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useEffect</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">callback</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> args</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #676E95\">/** </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">type</span><span style=\"color: #676E95\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #FFCB6B\">import('./internal').EffectHookState</span><span style=\"color: #89DDFF\">}</span><span style=\"color: #676E95\"> */</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">const</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">getHookState</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">currentIndex</span><span style=\"color: #89DDFF\">++,</span><span style=\"color: #F07178\"> </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #89DDFF\">!</span><span style=\"color: #A6ACCD\">options</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_skipEffects</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">&amp;&amp;</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">argsChanged</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_args</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">args</span><span style=\"color: #F07178\">)) </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">callback</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_args</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">args</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">currentComponent</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">__hooks</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_pendingEffects</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">push</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Aha!!! Notice the <code>if</code> block here. We're checking for 2 things.</p>\n<p><code>!options._skipEffects</code> - Preact has an options config, where you can turn off all side effects from running. So to run this <code>useEffect</code>, we have to make sure its safe to run effects.</p>\n<ol start=\"2\">\n<li><code>argsChanged(state._args, args)</code>: This one is very interesting. Remember the 2nd argument you pass to <code>useEffect</code>?</li>\n</ol>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #82AAFF\">useEffect</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #676E95\">/* Do epic shit */</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">},</span><span style=\"color: #A6ACCD\"> [emojiUpdated])</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Guess what, <code>argsChanged</code> is the function responsible for checking if changes were made in the dependencies passed to <code>useEffect</code>. Here, we pass it <code>state._args</code>, the argument list maintained by Preact for this specific hook, and the 2nd argument is the new set of dependencies. If any changes are detected, this function returns true, and the effect is run again.</p>\n<p>As for <code>argsChanged</code> function, its simply this <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘‡\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f447.svg\"></p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">argsChanged</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">oldArgs</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> newArgs</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> (</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #89DDFF\">!</span><span style=\"color: #A6ACCD\">oldArgs</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">||</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">oldArgs</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">length</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">!==</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">newArgs</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">length</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">||</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">newArgs</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">some</span><span style=\"color: #F07178\">(</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">arg</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">index</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #F07178\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">arg</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">!==</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">oldArgs</span><span style=\"color: #F07178\">[</span><span style=\"color: #A6ACCD\">index</span><span style=\"color: #F07178\">])</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  )</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Its basically checking if oldArgs even exist or not at first. Why?</p>\n<p>Cuz the dependency list passed to <code>useEffect</code> itself could be a state holding an array.</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #C792EA\">const</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">[</span><span style=\"color: #A6ACCD\">deps</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> setDeps</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useState</span><span style=\"color: #A6ACCD\">([])</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">useEffect</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #676E95\">/* Do epic shit */</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">},</span><span style=\"color: #A6ACCD\"> deps)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>OFC, a simple reason could be that you didn't pass the array. That is what most people would do rather than this above method <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜…\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f605.svg\">.</p>\n<p>2nd, its checking if argument list length is different or not. This is a smart move, because if the array size itself is changed, you don't need to go through and check every value.</p>\n<blockquote>\n<p>The cheapest function call is the one you never make ~~ <mark>Jason Miller</mark></p>\n</blockquote>\n<p>And finally, when all these conditions are true, we finally check if the values match up using the <code>arr.some</code> method.</p>\n<p>From what I can tell, this function is written in a way to stop as soon as it can. You could've written this same function in a way that it would do all these things, <strong>and then</strong> tell the result. Here, through some clever <mark>short circuiting </mark>, they made this function pretty efficient.</p>\n<h2 id=\"useLayoutEffect\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#useLayoutEffect\">#</a>useLayoutEffect</h2>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useLayoutEffect</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">callback</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> args</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #676E95\">/** </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">type</span><span style=\"color: #676E95\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #FFCB6B\">import('./internal').EffectHookState</span><span style=\"color: #89DDFF\">}</span><span style=\"color: #676E95\"> */</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">const</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">getHookState</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">currentIndex</span><span style=\"color: #89DDFF\">++,</span><span style=\"color: #F07178\"> </span><span style=\"color: #F78C6C\">4</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #89DDFF\">!</span><span style=\"color: #A6ACCD\">options</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_skipEffects</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">&amp;&amp;</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">argsChanged</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_args</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">args</span><span style=\"color: #F07178\">)) </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">callback</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_args</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">args</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">currentComponent</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_renderCallbacks</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">push</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>This hook is very, very interesting. If you read the code of <code>useEffect</code>, you'll find that they are exactly the same, except for the very last line.</p>\n<p>In <code>useEffect</code>, it is <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘‡\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f447.svg\"></p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #A6ACCD\">currentComponent</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">__hooks</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_pendingEffects</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">push</span><span style=\"color: #A6ACCD\">(state)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Whereas here it is <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ‘‡\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f447.svg\"></p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #A6ACCD\">currentComponent</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_renderCallbacks</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">push</span><span style=\"color: #A6ACCD\">(state)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>In <code>useEffect</code>, the effects to executed are pushed to a queue that executes asynchronously.</p>\n<p>Whereas in <code>useLayoutEffect</code>, the effects are pushed to the <code>render</code> callbacks, making it execute eagerly, as the rendering is going on. That's why its called use<strong>Layout</strong>Effect.</p>\n<p>Next up, is another hook that will blow your mind and change the way you write your <code>Ref</code>s. Yepp, you guessed it right, its <code>useRef</code> <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜Ž\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f60e.svg\"></p>\n<h2 id=\"useRef\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#useRef\">#</a>useRef <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜Ž\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f60e.svg\"></h2>\n<blockquote>\n<p>This hook's implementation is so cool that I can't help but put the Sunglasses emoji in front of it <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f601.svg\"></p>\n</blockquote>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useRef</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">initialValue</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">currentHook</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #F78C6C\">5</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">useMemo</span><span style=\"color: #F07178\">(</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #F07178\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #F07178\"> (</span><span style=\"color: #89DDFF\">{</span><span style=\"color: #F07178\"> current</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">initialValue</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">}</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> [])</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>If you notice, <code>useRef</code> is just <code>useMemo</code> in disguise, with an object that has one property: <code>current</code> with value null.</p>\n<p>So, effectively, you could write your refs as memos</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #C792EA\">const</span><span style=\"color: #A6ACCD\"> containerElementRef </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useMemo</span><span style=\"color: #A6ACCD\">(</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #A6ACCD\"> (</span><span style=\"color: #89DDFF\">{</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #F07178\">current</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">null</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">}</span><span style=\"color: #A6ACCD\">)</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> [])</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Don't take this too seriously though. Its better if element refs are assigned to proper <code>useRef</code> values only, as it is cleaner, the syntax is built around it.</p>\n<p>What I wanna point at is, is that a lot of people, especially beginners, equate <code>Ref</code> as the thing that holds DOM references, and that's all it do. Which is not a good thing really.</p>\n<p>But when you look at this code and realise that the Ref is just a value that's cached for the lifecycle of the component, clarity sinks in. The mental block and the sense of magic goes away, and you feel fully in control.</p>\n<h2 id=\"useCallback\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#useCallback\">#</a>useCallback</h2>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useCallback</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">callback</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> args</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">currentHook</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #F78C6C\">8</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">useMemo</span><span style=\"color: #F07178\">(</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #F07178\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">callback</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">args</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>And here's another hook that's just <code>useMemo</code> under the hood. This gives me the lols <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜‚\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f602.svg\"><img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜‚\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f602.svg\">. At this point, I'm simply giggling silently seeing that everything in Preact hooks is just <code>useMemo</code>.</p>\n<p><img src=\"\" alt=\"\" class=\"feature-image\" style=\"display: none;\"></p><div class=\"picture-container\">\n  <figure style=\"width: 100%;padding-top: 56.166666666666664%;\">\n    <picture>\n      <source type=\"image/jpg\" media=\"(min-width: 501px)\" data-srcset=\"/media/deep-dive-preact-source--always-has-been-meme/large.jpg\">\n      <source type=\"image/jpg\" media=\"(max-width: 500px)\" data-srcset=\"/media/deep-dive-preact-source--always-has-been-meme/small.jpg\">\n      <img alt=\"Placeholder\" data-src=\"/media/deep-dive-preact-source--always-has-been-meme/large.jpg\" class=\"lazyload blog-img\">\n    </picture>\n  </figure>\n  </div><p></p>\n<h2 id=\"useMemo\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#useMemo\">#</a>useMemo</h2>\n<p>Ahh, the star of the show, <code>useMemo</code>!!<img class=\"emoji\" draggable=\"false\" alt=\"ðŸ¤©\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f929.svg\"> Finally!</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useMemo</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">factory</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #A6ACCD\"> args</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #676E95\">/** </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">type</span><span style=\"color: #676E95\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #FFCB6B\">import('./internal').MemoHookState</span><span style=\"color: #89DDFF\">}</span><span style=\"color: #676E95\"> */</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">const</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">getHookState</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">currentIndex</span><span style=\"color: #89DDFF\">++,</span><span style=\"color: #F07178\"> </span><span style=\"color: #F78C6C\">7</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #82AAFF\">argsChanged</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_args</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">args</span><span style=\"color: #F07178\">)) </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">factory</span><span style=\"color: #F07178\">()</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_args</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">args</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_factory</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">factory</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>This one is pretty simple. Get the state for this specific hook, compare the previous dependencies to the new and update values and factory function passed to it if anything changes.</p>\n<p>And this again is so small, it makes me laugh as well as cry. Seriously, going through this codebase gives me huge imposter syndrome everytime. The architecture is so damn well done that code duplication isn't needed anywhere here, so everything is super small. Well done Preacters <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ¥²\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f972.svg\"></p>\n<h2 id=\"useContext\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#useContext\">#</a>useContext</h2>\n<p>One of the most favorite hooks of all time, <code>useContext</code> <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f60d.svg\"></p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useContext</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">const</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">provider</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">currentComponent</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #F07178\">[</span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_id</span><span style=\"color: #F07178\">]</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// We could skip this call here, but than we'd not call</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// `options._hook`. We need to do that in order to make</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// the devtools aware of this hook.</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #676E95\">/** </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">type</span><span style=\"color: #676E95\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #FFCB6B\">import('./internal').ContextHookState</span><span style=\"color: #89DDFF\">}</span><span style=\"color: #676E95\"> */</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">const</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">getHookState</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">currentIndex</span><span style=\"color: #89DDFF\">++,</span><span style=\"color: #F07178\"> </span><span style=\"color: #F78C6C\">9</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// The devtools needs access to the context object to</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// be able to pull of the default value when no provider</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// is present in the tree.</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_context</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #89DDFF\">!</span><span style=\"color: #A6ACCD\">provider</span><span style=\"color: #F07178\">) </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_defaultValue</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">  </span><span style=\"color: #676E95\">// This is probably not safe to convert to \"!\"</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">==</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">null</span><span style=\"color: #F07178\">) </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #FF9CAC\">true</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">provider</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">sub</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">currentComponent</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">provider</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">props</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">value</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Lots of comments here. If I remove all of them</p>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useContext</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">const</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">provider</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">currentComponent</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #F07178\">[</span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_id</span><span style=\"color: #F07178\">]</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">const</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">getHookState</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">currentIndex</span><span style=\"color: #89DDFF\">++,</span><span style=\"color: #F07178\"> </span><span style=\"color: #F78C6C\">9</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_context</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #89DDFF\">!</span><span style=\"color: #A6ACCD\">provider</span><span style=\"color: #F07178\">) </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">context</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_defaultValue</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">==</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">null</span><span style=\"color: #F07178\">) </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #FF9CAC\">true</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">provider</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">sub</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">currentComponent</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">provider</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">props</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">value</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Are you kidding me!?!? Just 7 lines in the body, and you have the biggest simplification that came when React hooks launched. What sorcery is this!! <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜‘\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f611.svg\"><img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜‘\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f611.svg\"></p>\n<p>Notable points here: If no provider is detected, it returns a default value, thanks to that 1 liner if statement. And if no value is found here, preact subscribes the current component to the context.</p>\n<h2 id=\"useErrorBoundary\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#useErrorBoundary\">#</a>useErrorBoundary</h2>\n<pre class=\"shiki\" style=\"background-color: #292D3E\"><code><span class=\"line\"><span style=\"color: #89DDFF\">export</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #C792EA\">function</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #82AAFF\">useErrorBoundary</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">cb</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #A6ACCD\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #676E95\">/** </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">type</span><span style=\"color: #676E95\"> </span><span style=\"color: #89DDFF\">{</span><span style=\"color: #FFCB6B\">import('./internal').ErrorBoundaryHookState</span><span style=\"color: #89DDFF\">}</span><span style=\"color: #676E95\"> */</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">const</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">getHookState</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">currentIndex</span><span style=\"color: #89DDFF\">++,</span><span style=\"color: #F07178\"> </span><span style=\"color: #F78C6C\">10</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #C792EA\">const</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">errState</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #82AAFF\">useState</span><span style=\"color: #F07178\">()</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #A6ACCD\">cb</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #89DDFF\">!</span><span style=\"color: #A6ACCD\">currentComponent</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">componentDidCatch</span><span style=\"color: #F07178\">) </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">currentComponent</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">componentDidCatch</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #A6ACCD\">err</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #F07178\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #89DDFF\">if</span><span style=\"color: #F07178\"> (</span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #A6ACCD\">_value</span><span style=\"color: #F07178\">) </span><span style=\"color: #A6ACCD\">state</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">_value</span><span style=\"color: #F07178\">(</span><span style=\"color: #A6ACCD\">err</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #A6ACCD\">errState</span><span style=\"color: #F07178\">[</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #F07178\">](</span><span style=\"color: #A6ACCD\">err</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #89DDFF\">};</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  </span><span style=\"color: #89DDFF\">return</span><span style=\"color: #F07178\"> [</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #A6ACCD\">errState</span><span style=\"color: #F07178\">[</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #F07178\">]</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #89DDFF\">()</span><span style=\"color: #F07178\"> </span><span style=\"color: #C792EA\">=&gt;</span><span style=\"color: #F07178\"> </span><span style=\"color: #89DDFF\">{</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">      </span><span style=\"color: #A6ACCD\">errState</span><span style=\"color: #F07178\">[</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #F07178\">](</span><span style=\"color: #89DDFF\">undefined</span><span style=\"color: #F07178\">)</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">    </span><span style=\"color: #89DDFF\">},</span></span>\n<span class=\"line\"><span style=\"color: #F07178\">  ]</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>I'm a huge, huge fan of <mark>Preact</mark> for providing a <code>useErrorBoundary</code> hook. In React, if you want error boundaries, you have to create a class component yourself and set at the root of your component tree. Whereas it ships by default in Preact, which makes my heart flutter <img class=\"emoji\" draggable=\"false\" alt=\"ðŸ˜…\" src=\"https://twemoji.maxcdn.com/v/13.0.2/svg/1f605.svg\"></p>\n<p>Notable points here: This hook mostly sets the <code>componentDidCatch</code> lifecycle to catch the errors and do what you tell this hook to do. Its more or less same as you yourself making a class component, only you don't have to nest anything here, just drop this hook in any component thats on top of the component tree.</p>\n<p>That's it for hooks. I didn't cover <code>useDebugValue</code> and <code>useImperativeHandle</code>, as I have never had to use <code>useDebugValue</code>, and <code>useImperativeHandle</code> is deemed unsafe to use Â¯\\_(ãƒ„)_/Â¯</p>\n<h1 id=\"A-note-on-simplicity\"><a class=\"heading-link\" href=\"blog/deep-dive-into-preact-source-code#A-note-on-simplicity\">#</a>A note on simplicity</h1>\n<p>Notice how I've been saying the code is super simple. Well, it is super easy to read, because that's how simple it is, but writing it is hard. Simplicity is rarely easy, its always harder to achieve. Writing a good, emotional rollercoaster in 100 words is hard. Throwing out excessive clothes is hard. Having a clean desk is harder than a cluttered desk.</p>\n<p>And making 3KB code for what was originally 42KB is hard.</p>\n<blockquote>\n<p>Subtraction is harder than addition, division is harder than multiplication.</p>\n</blockquote>\n<p>Making Preact by no means would've been an easy task, but Jason did it amazingly, and all the contributors that jumped in later made it even greater, while still keeping everything small and simpler. This is a monumental task. Hats off to the Preact team for this effort</p>\n<p><img src=\"\" alt=\"\" class=\"feature-image\" style=\"display: none;\"></p><div class=\"picture-container\">\n  <div class=\"gif-vid-container\">\n    <video autoplay=\"\" loop=\"\" muted=\"\" playsinline=\"\">\n      <source src=\"/media/deep-dive-preact-source--katniss-salute/vidgif.mp4\" type=\"video/mp4\">\n      Your browser doesn't support HTML5 video playback. <a href=\"/media/deep-dive-preact-source--katniss-salute.gif\" target=\"_blank\" rel=\"noopener\">See the gif here</a>\n    </video>\n  </div>\n  </div><p></p>\n<p>This is it for today!</p>\n<p>Signing off!!</p>\n","id":"deep-dive-into-preact-source-code","reading_time":22.43,"toc":[{"indent":0,"id":"","title":"What is Preact?","length":15},{"indent":0,"id":"","title":"Observations","length":12},{"indent":1,"id":"","title":"Written in TypeScript, but not quite...","length":39},{"indent":1,"id":"","title":"Very well written code","length":22},{"indent":1,"id":"","title":"It reuses itself a lot","length":22},{"indent":0,"id":"","title":"Disclaimer","length":10},{"indent":0,"id":"","title":"Core module","length":11},{"indent":1,"id":"","title":"index.js","length":8},{"indent":1,"id":"","title":"create-element.js","length":17},{"indent":2,"id":"","title":"createRef","length":9},{"indent":2,"id":"","title":"Fragment","length":8},{"indent":2,"id":"","title":"isValidElement","length":14},{"indent":1,"id":"","title":"render.js","length":9},{"indent":2,"id":"","title":"hydrate","length":7},{"indent":1,"id":"","title":"create-context.js","length":17},{"indent":0,"id":"","title":"Hooks","length":5},{"indent":1,"id":"","title":"useState","length":8},{"indent":1,"id":"","title":"useReducer","length":10},{"indent":1,"id":"","title":"useEffect","length":9},{"indent":1,"id":"","title":"useLayoutEffect","length":15},{"indent":1,"id":"","title":"useRef ðŸ˜Ž","length":9},{"indent":1,"id":"","title":"useCallback","length":11},{"indent":1,"id":"","title":"useMemo","length":7},{"indent":1,"id":"","title":"useContext","length":10},{"indent":1,"id":"","title":"useErrorBoundary","length":16},{"indent":0,"id":"","title":"A note on simplicity","length":20}]}